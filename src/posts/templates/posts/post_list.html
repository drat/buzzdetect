{% extends 'posts/base.html' %}

{% load humanize %}
{% load tz %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:posts_post_changelist' %}">All posts</a>
</div>
{% endblock %}

{% block content %}
<style type="text/css">
blockquote {
    border-left: 0;
    margin-left: 0;
}

blockquote.Tweet {
    display: block;
}
</style>

<div style="min-height:2000px">
<form method="GET" action="">
    <table>
        {{ form.as_table }}
        <tr>
            <td colspan="2">
                <input type="submit" value="Filter" />
            </td>
        </tr>
    </table>
</form>

<table>
{% for object in posts %}
<tr class="tweet" id="tweet-{{ object.pk }}">
    <td>
        <table class="stat" id="tweet-stat-{{ object.pk }}" width="99%">
            <tr>
                <th>
                    Minute
                </th>
                <th>
                    Reposts
                </td>
                <th>
                    <abbr title="Reposts by Friends">FR</abbr>
                </th>
                <th>
                    Speed
                </th>
                <th>
                    Accel
                </th>
                <th>
                    Repost per follower
                </th>
            </tr>
            {% for stat in object.stat_set.all %}
            <tr data-minute="{{ stat.minute }}">
                <td>
                    {{ stat.minute }}
                </td>
                <td>
                    {{ stat.reposts }}
                </td>
                <td>
                    {{ stat.friends_reposts }}
                </td>
                <td>
                    {{ stat.speed }}
                </td>
                <td>
                    {{ stat.acceleration }}
                </td>
                <td>
                    {{ stat.reposts_per_followers_count }}
                </td>
            </tr>
            {% endfor %}
            <tr>
                <th>Minute</th>
                <th>Poster total reposts</th>
                <th>Poster total posts</th>
                <th>Poster average</th>
                <th>Reposts</th>
                <th>Average compare</th>
            </tr>
            <tr class="result">
                <td>{{ object.result.minute }}</tD>
                <td>{{ object.result.poster_total_reposts }}</td>
                <td>{{ object.result.poster_total_posts }}</td>
                <td>{{ object.result.poster_average }}</td>
                <td>{{ object.result.reposts }}</td>
                <td>{{ object.result.average_compare }}</td>
            </tr>
        </table>
    </td>
    <td>
        <blockquote class="body" data-tweet-id="{{ object.upstream_id }}">
            <!--
            <a href="{{ object.poster.get_absolute_url }}">
                {{ object.poster }}
            </a>
            {{ object.content }}
            {{ object.datetime|naturaltime }}
            -->
        </blockquote>
        <a href="{{ object.get_absolute_url }}">
            Tweet details
        </a>
    </td>
</tr>
{% empty %}
<tr>
    <td>
        No matching tweet found
    </td>
</tr>
{% endfor %}
<table>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {

function reload() {
    $.ajax(
        window.location.href,
        {
            success: function(data, textStatus, jqXHR) {
                $(data).find('.tweet').each(function() {
                    div = $('#' + $(this).attr('id'));
                    if (div.length) {
                        // tweet exists with same index: continue
                        // tweet exists with different index: move
                        if (div.index() != $(this).index()) {
                            $('.tweet').eq($(this).index()).before(div);
                        }

                        // Update tweet stats
                        $(this).find('.stat tr[data-minute]').each(function() {
                            if (! div.find('.stat tr[data-minute='+ $(this).attr('data-minute')+']').length) {
                                $(this).insertAfter(div.find('.stat tr:first'));
                            }
                        });

                        $(this).find('.result').html(div.find('.result').html());
                    } else {
                        // tweet does not exist: add
                        $('.tweet').eq($(this).index()).before($(this));
                    }
                });

                $('.tweet').slice(100).remove();
            }
        }
    );

    renderTweets();
    setTimeout(reload, 1000);
};
setTimeout(reload, 1000);
});
</script>
{% endblock %}
